;;; task_manager-move_tasks.el --- –ü–µ—Ä–µ–Ω–æ—Å –∑–∞–¥–∞—á –º–µ–∂–¥—É INBOX –∏ TODO -*- lexical-binding: t; -*-
;;; –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:
;; –≠—Ç–æ—Ç –º–æ–¥—É–ª—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ –∑–∞–¥–∞—á –º–µ–∂–¥—É —Å—Ç–∞—Ç—É—Å–æ–º INBOX –∏ TODO,
;; –∞ —Ç–∞–∫–∂–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∏—Ö –º–µ–∂–¥—É —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º–∏ —Ñ–∞–π–ª–∞–º–∏ `inbox_tasks.org` –∏ `tasks.org`.
;; –ò–¥–µ—è –≤ —Ç–æ–º, —á—Ç–æ–±—ã –∏–º–µ—Ç—å –µ–¥–∏–Ω—ã–π —Ö–æ—Ç–∫–µ–π –∏ ¬´—É–º–Ω—É—é¬ª –∫–æ–º–∞–Ω–¥—É, –∫–æ—Ç–æ—Ä–∞—è —Å–∞–º–∞ —Ä–µ—à–∞–µ—Ç, –∫—É–¥–∞ –Ω—É–∂–Ω–æ
;; –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –∑–∞–¥–∞—á—É (–∏–∑ INBOX –≤ TODO –∏–ª–∏ –Ω–∞–æ–±–æ—Ä–æ—Ç).
;; üìå –í –±—É–¥—É—â–µ–º —ç—Ç–æ—Ç —Ñ–∞–π–ª –±—É–¥–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω:
;; - –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –≤—ã–±–æ—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ –ø—Ä–∏ –ø–µ—Ä–µ–Ω–æ—Å–µ –∑–∞–¥–∞—á –∏–∑ INBOX –≤ tasks.org;
;; - –∞–≤—Ç–æ–ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–æ–π –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –ø—Ä–æ–µ–∫—Ç–æ–≤ –∏ –≤–æ–∑–º–æ–∂–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –∑–∞–¥–∞—á –ø–æ –Ω–∏–º.

;; ------------------------------
;; üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
;; ------------------------------

(defconst my/tasks-file
  "E:\\YandexDisk\\2 area\\10 Emacs\\New managment emacs\\task-tracker\\tasks.org"
  "–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É tasks.org –¥–ª—è –∑–∞–¥–∞—á –≤ —Å—Ç–∞—Ç—É—Å–µ TODO.")

;; ------------------------------
;; ‚öôÔ∏è –ü–∞–Ω–µ–ª—å –≥–æ—Ä—è—á–∏—Ö –∫–ª–∞–≤–∏—à
;; ------------------------------
;; (global-set-key (kbd "C-c t v") 'my/move-task-smart) ;; —É–º–Ω–æ–µ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏

;; ------------------------------
;; üìé –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –∞–≥–µ–Ω—Ç–æ–≤ / –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤ –∫–æ–Ω—Ñ–∏–≥–æ–≤
;; ------------------------------
;; –ß—Ç–æ–±—ã –≤–∞—à–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–ª–∞—Å—å –º–æ–∏–º –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–º —Å–ª–æ–≤–∞—Ä—è —à–æ—Ä—Ç–∫–∞—Ç–æ–≤:
;;
;; 1. –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–ø–∏—Å–∞–Ω—ã –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ:
;;    (global-set-key (kbd "C-c t v") 'my/move-task-smart) ;; —É–º–Ω–æ–µ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
;;
;; 2. –ò–ª–∏ —á–µ—Ä–µ–∑ define-key:
;;    (define-key some-map (kbd "C-c t v") 'my/move-task-smart) ;; —É–º–Ω–æ–µ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
;;
;; 3. –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ç–∞–∫–∏—Ö —Å—Ç—Ä–æ–∫:
;;    ^\\s-*\\((\\(global-set-key\\|define-key\\).*\\)$
;;
;; 4. –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å) –∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –≤ —Ç–æ–π –∂–µ —Å—Ç—Ä–æ–∫–µ:
;;    ;; –∫–æ—Ä–æ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Å–æ—á–µ—Ç–∞–Ω–∏—è –∫–ª–∞–≤–∏—à

;; ------------------------------
;; 1. –§—É–Ω–∫—Ü–∏–∏ –ø–µ—Ä–µ–Ω–æ—Å–∞ –∑–∞–¥–∞—á
;; ------------------------------

(defun my/move-inbox-to-todo ()
  "–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –∑–∞–¥–∞—á—É –∏–∑ INBOX –≤ TODO –∏ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –µ—ë –∏–∑ `inbox_tasks.org` –≤ `tasks.org`.
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –∑–∞–¥–∞—á–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∏–º–µ–µ—Ç —Å—Ç–∞—Ç—É—Å INBOX.
- –í—ã—Ä–µ–∑–∞–µ—Ç –ø–æ–¥–¥–µ—Ä–µ–≤–æ —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∏ –≤—Å—Ç–∞–≤–ª—è–µ—Ç –µ–≥–æ –≤ —Å–µ–∫—Ü–∏—é
  \"* Tasks\" —Ñ–∞–π–ª–∞ `tasks.org`, –º–µ–Ω—è—è –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å \"* INBOX\" –Ω–∞ \"* TODO\".
- –ï—Å–ª–∏ —Ä–∞–∑–¥–µ–ª \"* Tasks\" –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –æ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è."
  (interactive)
  (org-back-to-heading t)
  (let ((task-start (point))
        (task-end   (save-excursion (org-end-of-subtree) (point)))
        (inbox-buf  (current-buffer))
        (tasks-buf  (find-file-noselect my/tasks-file)))
    ;; –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏
    (if (not (string= (org-get-todo-state) "INBOX"))
        (message "‚ùå –û—à–∏–±–∫–∞: –∑–∞–¥–∞—á–∞ —É–∂–µ –Ω–µ –≤ —Å—Ç–∞—Ç—É—Å–µ INBOX")
      ;; –í—ã—Ä–µ–∑–∞–µ–º –ø–æ–¥–¥–µ—Ä–µ–≤–æ –∑–∞–¥–∞—á–∏
      (kill-region task-start task-end)
      ;; –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –≤ –±—É—Ñ–µ—Ä —Å TODO-–∑–∞–¥–∞—á–∞–º–∏ –∏ –≤—Å—Ç–∞–≤–ª—è–µ–º
      (with-current-buffer tasks-buf
        (goto-char (point-min))
        (if (re-search-forward "^\\* Tasks" nil t)
            (forward-line 1)
          ;; –ï—Å–ª–∏ —Å–µ–∫—Ü–∏–∏ –Ω–µ—Ç, —Å–æ–∑–¥–∞—ë–º
          (goto-char (point-min))
          (insert "* Tasks\n"))
        ;; –ú–µ–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å INBOX –Ω–∞ TODO –∏ –≤—Å—Ç–∞–≤–ª—è–µ–º
        (insert
         (replace-regexp-in-string
          "^\\* INBOX" "* TODO" (current-kill 0)))
        (save-buffer))
      ;; –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –∏—Å—Ö–æ–¥–Ω—ã–π –±—É—Ñ–µ—Ä –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ
      (with-current-buffer inbox-buf
        (save-buffer))
      (message "‚úÖ –ó–∞–¥–∞—á–∞ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–∞ –≤ TODO –∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞ –≤ tasks.org"))))

(defun my/move-todo-to-inbox ()
  "–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –∑–∞–¥–∞—á—É –∏–∑ –ª—é–±–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ (–∫—Ä–æ–º–µ INBOX) –≤ INBOX
–∏ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –µ—ë –∏–∑ `tasks.org` –≤ `inbox_tasks.org`.
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –∑–∞–¥–∞—á–∞ –Ω–µ –≤ —Å—Ç–∞—Ç—É—Å–µ INBOX.
- –í—ã—Ä–µ–∑–∞–µ—Ç –ø–æ–¥–¥–µ—Ä–µ–≤–æ —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∏ –≤—Å—Ç–∞–≤–ª—è–µ—Ç –µ–≥–æ –≤ —Å–µ–∫—Ü–∏—é
  \"* Tasks\" —Ñ–∞–π–ª–∞ `inbox_tasks.org`, –º–µ–Ω—è—è –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–∞ \"* INBOX\".
- –ï—Å–ª–∏ —Ä–∞–∑–¥–µ–ª \"* Tasks\" –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –æ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è."
  (interactive)
  (org-back-to-heading t)
  (let ((task-start (point))
        (task-end   (save-excursion (org-end-of-subtree) (point)))
        (tasks-buf  (current-buffer))
        (inbox-buf  (find-file-noselect my/inbox-file)))
    (if (string= (org-get-todo-state) "INBOX")
        (message "‚ùå –û—à–∏–±–∫–∞: –∑–∞–¥–∞—á–∞ —É–∂–µ –≤ —Å—Ç–∞—Ç—É—Å–µ INBOX")
      ;; –í—ã—Ä–µ–∑–∞–µ–º –ø–æ–¥–¥–µ—Ä–µ–≤–æ
      (kill-region task-start task-end)
      ;; –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –≤ –±—É—Ñ–µ—Ä INBOX –∏ –≤—Å—Ç–∞–≤–ª—è–µ–º
      (with-current-buffer inbox-buf
        (goto-char (point-min))
        (if (re-search-forward "^\\* Tasks" nil t)
            (forward-line 1)
          ;; –ï—Å–ª–∏ —Å–µ–∫—Ü–∏–∏ –Ω–µ—Ç, —Å–æ–∑–¥–∞—ë–º
          (goto-char (point-min))
          (insert "* Tasks\n"))
        (insert
         (replace-regexp-in-string
          "^\\* [A-Z]+"
          "* INBOX"
          (current-kill 0)))
        (save-buffer))
      (with-current-buffer tasks-buf
        (save-buffer))
      (message "‚úÖ –ó–∞–¥–∞—á–∞ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–∞ –≤ INBOX –∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞ –≤ inbox_tasks.org"))))

(defun my/move-task-smart ()
  "–£–º–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á–∏ –º–µ–∂–¥—É INBOX –∏ TODO.
–ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ —É–∂–µ INBOX, —Ç–æ–≥–¥–∞ –≤—ã–∑—ã–≤–∞–µ—Ç `my/move-inbox-to-todo`.
–ò–Ω–∞—á–µ ‚Äî –≤—ã–∑—ã–≤–∞–µ—Ç `my/move-todo-to-inbox`."
  (interactive)
  (if (string= (org-get-todo-state) "INBOX")
      (my/move-inbox-to-todo)
    (my/move-todo-to-inbox)))

;; –ü—Ä–∏–º–µ—Ä –ø—Ä–∏–≤—è–∑–∫–∏ –∫ —Ö–æ—Ç–∫–µ—é C-c t v
(global-set-key (kbd "C-c t v") 'my/move-task-smart) ;; —É–º–Ω–æ–µ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏

(provide 'task_manager-move_tasks)
