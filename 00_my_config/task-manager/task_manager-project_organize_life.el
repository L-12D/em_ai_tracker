;;; task_manager-project_organize_life.el --- –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –∑–∞–¥–∞—á –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º –≤ life-tasks.org -*- lexical-binding: t; -*-

;;; –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:
;; –ú–æ–¥—É–ª—å –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∑–∞–¥–∞—á –≤ —Ñ–∞–π–ª `life-tasks.org`,
;; –≥–¥–µ –æ–Ω–∏ –≥—Ä—É–ø–ø–∏—Ä—É—é—Ç—Å—è –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º, —Å–≤—è–∑–∞–Ω–Ω—ã–º —Å –ª–∏—á–Ω–æ–π –∂–∏–∑–Ω—å—é, —Ö–æ–±–±–∏ –∏ —Ü–µ–ª—è–º–∏ –≤–Ω–µ —Ä–∞–±–æ—á–µ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.
;;
;; –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç—Ä–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è:
;; - –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø—Ä–æ–µ–∫—Ç
;; - –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –ø—Ä–∏ –ø–µ—Ä–µ–Ω–æ—Å–µ
;; - –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ —Å —Ç–µ–º –∂–µ –Ω–∞–∑–≤–∞–Ω–∏–µ–º, —á—Ç–æ —É –∑–∞–¥–∞—á–∏ ("–ë–µ–∑ –ø—Ä–æ–µ–∫—Ç–∞")
;;
;; –ó–∞–¥–∞—á–∞ –ø–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å LIFE –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞.

;; ------------------------------
;; üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
;; ------------------------------

(defconst my/life-tasks-file
  (expand-file-name "../../task-tracker/life-tasks.org" (file-name-directory (or load-file-name buffer-file-name)))
  "–û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É life-tasks.org –¥–ª—è –∑–∞–¥–∞—á, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –ª–∏—á–Ω–æ–π –∂–∏–∑–Ω—å—é.")

;; ------------------------------
;; ‚öôÔ∏è –ü–∞–Ω–µ–ª—å –≥–æ—Ä—è—á–∏—Ö –∫–ª–∞–≤–∏—à
;; ------------------------------
;; (global-set-key (kbd "C-c t l") 'my/move-to-life-tasks) ;; –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –∑–∞–¥–∞—á—É –≤ life-tasks.org

;; ------------------------------
;; üìé –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –∞–≥–µ–Ω—Ç–æ–≤ / –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤ –∫–æ–Ω—Ñ–∏–≥–æ–≤
;; ------------------------------
;; –ß—Ç–æ–±—ã –≤–∞—à–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–ª–∞—Å—å –º–æ–∏–º –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–º —Å–ª–æ–≤–∞—Ä—è —à–æ—Ä—Ç–∫–∞—Ç–æ–≤:
;;
;; 1. –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–ø–∏—Å–∞–Ω—ã –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ:
;;    (global-set-key (kbd "C-c t l") 'my/move-to-life-tasks) ;; –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –∑–∞–¥–∞—á—É –≤ life-tasks.org
;;
;; 2. –ò–ª–∏ —á–µ—Ä–µ–∑ define-key:
;;    (define-key some-map (kbd "C-c t l") 'my/move-to-life-tasks) ;; –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –∑–∞–¥–∞—á—É –≤ life-tasks.org
;;
;; 3. –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ç–∞–∫–∏—Ö —Å—Ç—Ä–æ–∫:
;;    ^\\s-*\\((\\(global-set-key\\|define-key\\).*\\)$
;;
;; 4. –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å) –∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –≤ —Ç–æ–π –∂–µ —Å—Ç—Ä–æ–∫–µ:
;;    ;; –∫–æ—Ä–æ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Å–æ—á–µ—Ç–∞–Ω–∏—è –∫–ª–∞–≤–∏—à

;; ------------------------------
;; 1. –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤
;; ------------------------------

(defun my/get-life-projects ()
  "–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ –∏–∑ —Ñ–∞–π–ª–∞ `life-tasks.org`.
–ò—â–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∏ –≤–∏–¥–∞ `* –ü—Ä–æ–µ–∫—Ç: ...` –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–æ–≤."
  (with-current-buffer (find-file-noselect my/life-tasks-file)
    (goto-char (point-min))
    (let (projects)
      (while (re-search-forward "^\\* –ü—Ä–æ–µ–∫—Ç: \\(.+\\)$" nil t)
        (push (match-string 1) projects))
      (nreverse projects))))

;; ------------------------------
;; 2. –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ –≤ life-tasks.org
;; ------------------------------

(defun my/move-to-life-tasks ()
  "–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —Ç–µ–∫—É—â—É—é –∑–∞–¥–∞—á—É –≤ —Ñ–∞–π–ª `life-tasks.org` –≤ —Å—Ç–∞—Ç—É—Å–µ LIFE —Å –≤—ã–±–æ—Ä–æ–º –ø—Ä–æ–µ–∫—Ç–∞.
–ó–∞–¥–∞—á–∞ –±—É–¥–µ—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω–∞ –ø–æ–¥ –Ω—É–∂–Ω—ã–º –ø—Ä–æ–µ–∫—Ç–æ–º. –í–æ–∑–º–æ–∂–µ–Ω –≤—ã–±–æ—Ä:
- —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞;
- —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞;
- –∏–ª–∏ '–ë–µ–∑ –ø—Ä–æ–µ–∫—Ç–∞' ‚Äî —Ç–æ–≥–¥–∞ –ø—Ä–æ–µ–∫—Ç —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∑–∞–¥–∞—á–∏."
  (interactive)
  (org-back-to-heading t)
  (let ((task-start (point))
        (task-end   (save-excursion (org-end-of-subtree) (point)))
        (source-buffer (current-buffer))
        (life-tasks-buffer (find-file-noselect my/life-tasks-file)))
    (let* ((projects (append (my/get-life-projects) '("–ë–µ–∑ –ø—Ä–æ–µ–∫—Ç–∞" "–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç")))
           (selected-project (completing-read "–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç –¥–ª—è life-tasks: " projects nil nil)))
      (kill-region task-start task-end)
      (with-current-buffer life-tasks-buffer
        (goto-char (point-min))
        (cond
         ;; –ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç
         ((string= selected-project "–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç")
          (let ((new-project-name (read-string "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞: ")))
            (goto-char (point-max))
            (insert (format "\n* –ü—Ä–æ–µ–∫—Ç: %s\n" new-project-name))
            (insert (replace-regexp-in-string "^\\* \\w+" "* LIFE" (current-kill 0)))))

         ;; –ë–µ–∑ –ø—Ä–æ–µ–∫—Ç–∞ ‚Äî —Å–æ–∑–¥–∞—ë–º –ø—Ä–æ–µ–∫—Ç —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –∑–∞–¥–∞—á–∏
         ((string= selected-project "–ë–µ–∑ –ø—Ä–æ–µ–∫—Ç–∞")
          (goto-char (point-max))
          (let ((task-title (replace-regexp-in-string
                             "^\\* \\w+ \\(\\[#[A-C]\\] \\)?\\(.+?\\)\\( :.+:\\)?$"
                             "\\2" (current-kill 0))))
            (insert (format "\n* –ü—Ä–æ–µ–∫—Ç: %s\n" task-title))
            (insert (replace-regexp-in-string "^\\* \\w+" "* LIFE" (current-kill 0)))))

         ;; –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø—Ä–æ–µ–∫—Ç
         (t
          (if (re-search-forward (format "^\\* –ü—Ä–æ–µ–∫—Ç: %s$" (regexp-quote selected-project)) nil t)
              (progn
                (forward-line 1)
                (insert (replace-regexp-in-string "^\\* \\w+" "* LIFE" (current-kill 0))))
            ;; –ï—Å–ª–∏ –≤–¥—Ä—É–≥ –ø—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω (—Ö–æ—Ç—è –≤—ã–±—Ä–∞–Ω), —Å–æ–∑–¥–∞—ë–º –µ–≥–æ –≤ –∫–æ–Ω—Ü–µ
            (goto-char (point-max))
            (insert (format "\n* –ü—Ä–æ–µ–∫—Ç: %s\n" selected-project))
            (insert (replace-regexp-in-string "^\\* \\w+" "* LIFE" (current-kill 0))))))
        (save-buffer))
      (with-current-buffer source-buffer
        (save-buffer))
      (message "‚úÖ –ó–∞–¥–∞—á–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞ –≤ life-tasks.org –≤ —Å—Ç–∞—Ç—É—Å–µ LIFE"))))

;; ------------------------------
;; 3. –ì–æ—Ä—è—á–∞—è –∫–ª–∞–≤–∏—à–∞
;; ------------------------------
(global-set-key (kbd "C-c t l") 'my/move-to-life-tasks) ;; –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤ life-tasks.org

(provide 'task_manager-project_organize_life)
;;; task_manager-project_organize_life.el ends here
